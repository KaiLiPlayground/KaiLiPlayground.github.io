<p>Certainly! To complete your AWS CloudFormation setup, you’ll need additional templates for the SNS topic, the Step Function, and the CodePipeline setup. Let’s define these templates:</p>
<h3 id="1-CloudFormation-Template-for-SNS-Topic"><a href="#1-CloudFormation-Template-for-SNS-Topic" class="headerlink" title="1. CloudFormation Template for SNS Topic"></a>1. CloudFormation Template for SNS Topic</h3><pre><code class="yaml">AWSTemplateFormatVersion: &#39;2010-09-09&#39;
Resources:
  DataEngFailureNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: &quot;add valid email address&quot;
          Protocol: email

Outputs:
  DataEngFailureNotificationTopicArn:
    Description: &quot;ARN of the SNS Topic for Failure Notifications&quot;
    Value: !Ref DataEngFailureNotificationTopic
</code></pre>
<h3 id="2-CloudFormation-Template-for-Step-Function"><a href="#2-CloudFormation-Template-for-Step-Function" class="headerlink" title="2. CloudFormation Template for Step Function"></a>2. CloudFormation Template for Step Function</h3><p>This template assumes the existence of the two Lambda functions and the SNS topic. Make sure to replace <code>&lt;LambdaFunctionARN1&gt;</code> and <code>&lt;LambdaFunctionARN2&gt;</code> with the actual ARNs or reference them appropriately if they are part of the same CloudFormation stack.</p>
<pre><code class="yaml">AWSTemplateFormatVersion: &#39;2010-09-09&#39;
Resources:
  DataEngStepFunction:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      RoleArn: !GetAtt StepFunctionExecutionRole.Arn
      DefinitionString: 
        !Sub |
          {
            &quot;StartAt&quot;: &quot;CheckFileExtension&quot;,
            &quot;States&quot;: {
              &quot;CheckFileExtension&quot;: {
                &quot;Type&quot;: &quot;Task&quot;,
                &quot;Resource&quot;: &quot;&lt;LambdaFunctionARN1&gt;&quot;,
                &quot;Next&quot;: &quot;ChoiceState&quot;
              },
              &quot;ChoiceState&quot;: {
                &quot;Type&quot;: &quot;Choice&quot;,
                &quot;Choices&quot;: [
                  {
                    &quot;Variable&quot;: &quot;$.file_extension&quot;,
                    &quot;StringEquals&quot;: &quot;.csv&quot;,
                    &quot;Next&quot;: &quot;ProcessFile&quot;
                  }
                ],
                &quot;Default&quot;: &quot;NotifyFailure&quot;
              },
              &quot;ProcessFile&quot;: {
                &quot;Type&quot;: &quot;Task&quot;,
                &quot;Resource&quot;: &quot;&lt;LambdaFunctionARN2&gt;&quot;,
                &quot;End&quot;: true
              },
              &quot;NotifyFailure&quot;: {
                &quot;Type&quot;: &quot;Task&quot;,
                &quot;Resource&quot;: &quot;arn:aws:states:::sns:publish&quot;,
                &quot;Parameters&quot;: {
                  &quot;TopicArn&quot;: &quot;${DataEngFailureNotificationTopicArn}&quot;,
                  &quot;Message&quot;: &quot;File processing failed.&quot;
                },
                &quot;End&quot;: true
              }
            }
          }
  StepFunctionExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: &#39;2012-10-17&#39;
        Statement:
          - Effect: Allow
            Principal:
              Service: [states.amazonaws.com]
            Action: [&#39;sts:AssumeRole&#39;]
      Policies:
        - PolicyName: StepFunctionLambdaSNSAccess
          PolicyDocument:
            Version: &#39;2012-10-17&#39;
            Statement:
              - Effect: Allow
                Action: 
                  - &#39;lambda:InvokeFunction&#39;
                  - &#39;sns:Publish&#39;
                Resource: &#39;*&#39;

Outputs:
  StepFunctionArn:
    Description: &quot;ARN of the Step Function&quot;
    Value: !Ref DataEngStepFunction
</code></pre>
<h3 id="3-CloudFormation-Template-for-CodePipeline"><a href="#3-CloudFormation-Template-for-CodePipeline" class="headerlink" title="3. CloudFormation Template for CodePipeline"></a>3. CloudFormation Template for CodePipeline</h3><p>This template sets up a pipeline in CodePipeline that pulls from CodeCommit, builds using CodeBuild, and then deploys using CloudFormation. Ensure your <code>buildspec.yml</code> and source code are in the CodeCommit repository.</p>
<pre><code class="yaml">AWSTemplateFormatVersion: &#39;2010-09-09&#39;
Resources:
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref CodePipelineArtifactStore
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: 1
                Provider: CodeCommit
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                RepositoryName: !Ref CodeCommitRepoName
                BranchName: main
        - Name: Build
          Actions:
            - Name: BuildAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: BuildOutput
              Configuration:
                ProjectName: !Ref CodeBuildProject
        - Name: Deploy
          Actions:
            - Name: DeployAction
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: 1
                Provider: CloudFormation
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: MyServerlessApplicationStack
                TemplatePath: BuildOutput::packaged-template.yaml
                Capabilities: CAPABILITY_IAM

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: &#39;2012-10-17&#39;
        Statement:
          - Effect: Allow
            Principal:
              Service: [codepipeline.amazonaws.com]
            Action: [&#39;sts:AssumeRole&#39;]
      Policies:
        - PolicyName: CodePipelineAccess
          PolicyDocument:
            Version: &#39;2012-10-17&#39;
            Statement:
              - Effect: Allow
                Action: 
                  - &#39;codecommit:*&#39;
                  - &#39;s3:*&#39;
                  - &#39;codebuild:*&#39;
                  - &#39;cloudformation:*&#39;
                Resource: &#39;*&#39;

  CodePipelineArtifactStore:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled

Outputs:
  PipelineName:
    Description: &quot;Name of the CodePipeline&quot;
    Value: !Ref CodePipeline
</code></pre>
<h3 id="Integration-Notes"><a href="#Integration-Notes" class="headerlink" title="Integration Notes"></a>Integration Notes</h3><ul>
<li>Update the placeholders (e.g., <code>&lt;LambdaFunctionARN1&gt;</code>, <code>&lt;LambdaFunctionARN2&gt;</code>, CodeCommit repository name) with actual values or references.</li>
<li>Make sure your <code>buildspec.yml</code> in the CodeBuild project can package the Lambda functions and CloudFormation templates correctly.</li>
<li>The pipeline assumes your source code and CloudFormation templates are stored in an AWS CodeCommit repository.</li>
</ul>
<p>By following this approach, you will have a fully automated CI&#x2F;CD pipeline for your serverless application, managing everything from source control to deployment in a streamlined and version-controlled manner.</p>
